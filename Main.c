#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <math.h>

#define Q31_1_BASE (1LL<<30)
#define Q31_1_MAX  ((1<<30)-1)
#define Q31_1_MIN  (-1<<30)
#define ONE_SIZE (128)

int32_t Saturation(int64_t R)
{
	if (R < (int64_t)Q31_1_MIN)
		return Q31_1_MIN;

	else if (R > (int64_t)Q31_1_MAX)
		return Q31_1_MAX;

	return R;
}

int32_t round_up(int64_t x) {

	return (x + (1LL << 30) >> 30);
}

int32_t flt2fixd(float x)
{
	if (x >= 1)
		return Q31_1_MAX;
	else if (x < -1)
		return Q31_1_MIN;

	int32_t res = x * (float)Q31_1_BASE;
	return res;
}

float fixd2flt(int32_t x)
{
	float res = (float)(x) / ((float)Q31_1_BASE);
	return res;
	return res;
}

struct HEADER
{
	uint8_t ChunkID[4];
	uint32_t ChunkSize;
	uint8_t Format[4];
	uint8_t Subchunk1ID[4];
	uint32_t Subchunk1Size;
	uint16_t AudioFormat;
	uint16_t NumChannels;
	uint32_t SampleRate;
	uint32_t ByteRate;
	uint16_t BlockAlign;
	uint16_t BitsPreSample;
};

struct CHUNK
{
	uint8_t ID[4];
	uint32_t size;
};

double coefs[128] = { -0.000162164358122296535080070212231362348,
0.001871990160621829881251731997338083602,
0.000177421074278205637142491468694061041,
-0.000799938339957202400667957142843533802,
0.000029445930738341338089858467697013111,
0.000975875559570133681644432677160239109,
-0.000174332633474075845286810348966355377,
-0.001142739689442697631482914744083245751,
0.000370491577463436688212594649627362742,
0.001301881690598231770816806118773456546,
-0.000622077986506033506208801497905369615,
-0.001441449932844418493210758569489371439,
0.000932402583730824563272576721573159375,
0.001550174587877081733289230669470271096,
-0.001302822619389340953049982729794464831,
-0.001613386681590385333950887769560722518,
0.001732469863172050698885140462834897335,
0.001616617300957494916813228513774447492,
-0.00221862576667492894869071484720279841,
-0.001543657072345475025215710829229465162,
0.002754940419298467901149107817104777496,
0.001378463028443757676377856569160940126,
-0.003333276559124515384113784932651469717,
-0.001103707153510167897347837850929863635,
0.003941689681336679740297768148593604565,
0.000703262526727135503512577940909977769,
-0.004565291704341306600056782372121233493,
-0.000160412088138313022045444711238815216,
0.005184773540519031602424870897038999829,
-0.000539621548383245391508622468279554596,
-0.005778912866566685360703026219653111184,
0.001411823120786187893416219196751626441,
0.006322138141064522626200172794597165193,
-0.00246974610702698545855460210418641509,
-0.006786253611573941565970891076631232863,
0.003728315587545509915412544899027125211,
0.00713721779746414979050950222472238238,
-0.005200340179343024282765384214144432917,
-0.007338326806005588710812848063369528973,
0.006901001742960421840578089103246384184,
0.007346158056545955619687227056147094117,
-0.00884755574351601785376697506535492721,
-0.007111774028954947340919190423846885096,
0.011067298609159212374741798612376442179,
0.006570507333481337766678542777754046256,
-0.013595462859419383747083820423995348392,
-0.005644429523601306696034551890761576942,
0.016492964039346743460034971917593793478,
0.004223704726346500307188058798146812478,
-0.019858876451125911932749090738070663065,
-0.002145249494208243887238829472607903881,
0.02386518959950843093986705412135052029,
-0.000856104435109718980845272540136647876,
-0.028832854859967373128970535844928235747,
0.005258383178987129091819241466509993188,
0.035404998106579571581775667254987638444,
-0.012038069712799946003878304168210888747,
-0.045046331468904660111363114083360414952,
0.023589425202695950972708871518079831731,
0.06186864353234792363034344475636316929,
-0.047784444108668819306551256431703222916,
-0.103231863934425432960395596637681592256,
0.134497338921223313912278740644978825003,
0.464599278002360449590923963114619255066,
0.464599278002360449590923963114619255066,
0.134497338921223313912278740644978825003,
-0.103231863934425432960395596637681592256,
-0.047784444108668819306551256431703222916,
0.06186864353234792363034344475636316929,
0.023589425202695950972708871518079831731,
-0.045046331468904660111363114083360414952,
-0.012038069712799946003878304168210888747,
0.035404998106579571581775667254987638444,
0.005258383178987129091819241466509993188,
-0.028832854859967373128970535844928235747,
-0.000856104435109718980845272540136647876,
0.02386518959950843093986705412135052029,
-0.002145249494208243887238829472607903881,
-0.019858876451125911932749090738070663065,
0.004223704726346500307188058798146812478,
0.016492964039346743460034971917593793478,
-0.005644429523601306696034551890761576942,
-0.013595462859419383747083820423995348392,
0.006570507333481337766678542777754046256,
0.011067298609159212374741798612376442179,
-0.007111774028954947340919190423846885096,
-0.00884755574351601785376697506535492721,
0.007346158056545955619687227056147094117,
0.006901001742960421840578089103246384184,
-0.007338326806005588710812848063369528973,
-0.005200340179343024282765384214144432917,
0.00713721779746414979050950222472238238,
0.003728315587545509915412544899027125211,
-0.006786253611573941565970891076631232863,
-0.00246974610702698545855460210418641509,
0.006322138141064522626200172794597165193,
0.001411823120786187893416219196751626441,
-0.005778912866566685360703026219653111184,
-0.000539621548383245391508622468279554596,
0.005184773540519031602424870897038999829,
-0.000160412088138313022045444711238815216,
-0.004565291704341306600056782372121233493,
0.000703262526727135503512577940909977769,
0.003941689681336679740297768148593604565,
-0.001103707153510167897347837850929863635,
-0.003333276559124515384113784932651469717,
0.001378463028443757676377856569160940126,
0.002754940419298467901149107817104777496,
-0.001543657072345475025215710829229465162,
-0.00221862576667492894869071484720279841,
0.001616617300957494916813228513774447492,
0.001732469863172050698885140462834897335,
-0.001613386681590385333950887769560722518,
-0.001302822619389340953049982729794464831,
0.001550174587877081733289230669470271096,
0.000932402583730824563272576721573159375,
-0.001441449932844418493210758569489371439,
-0.000622077986506033506208801497905369615,
0.001301881690598231770816806118773456546,
0.000370491577463436688212594649627362742,
-0.001142739689442697631482914744083245751,
-0.000174332633474075845286810348966355377,
0.000975875559570133681644432677160239109,
0.000029445930738341338089858467697013111,
-0.000799938339957202400667957142843533802,
0.000177421074278205637142491468694061041,
0.001871990160621829881251731997338083602,
-0.000162164358122296535080070212231362348 };

void coef2fixd(double* coefs, int32_t* fixcoefs, int order) {

	for (int i = 0; i < order; i++) {
		fixcoefs[i] = flt2fixd(coefs[i]);
	}
}

typedef struct {
	uint8_t index;
	int16_t buffer_L[ONE_SIZE];
	int16_t buffer_R[ONE_SIZE];
} Ring;

void RING_Init(Ring* buf)
{
	{
		for (int i = 0; i < ONE_SIZE; i++)
		{
			buf->buffer_L[i] = 0;
			buf->buffer_R[i] = 0;
		}
		buf->index = 0;
	}
}

int32_t FIR(int16_t* buffer, int32_t* coefs, uint8_t index) {
	int64_t acc = 0;
	int32_t sample1;

	for (int n = 0; n < ONE_SIZE; n++)
	{
		int indx = (index + n) & ONE_SIZE - 1;
		sample1 = buffer[indx];
		acc += (int64_t)sample1 * coefs[n];
	}
	return round_up(acc);
}

int main() {

	FILE* file_in;
	FILE* file_out;
	struct HEADER header;
	struct CHUNK chunk;

	int8_t filename[30];
	puts("Enter filename:");
	gets(filename);

	fopen_s(&file_in, filename, "rb");
	fopen_s(&file_out, "filteredwave.wav", "wb");

	fread(&header, sizeof(header), 1, file_in);

	printf("NumChannels=%i\n", header.NumChannels);
	printf("SampleRate=%i\n", header.SampleRate);
	printf("BitsPreSample=%i\n", header.BitsPreSample);

	if (header.BitsPreSample != 16) {
		printf("Audiofile isn't 16bit's\n");
		system("pause");
		return 0;
	}

	while (1)
	{
		fread(&chunk, sizeof(chunk), 1, file_in);
		if (*(uint32_t*)&chunk.ID == 0x61746164)
			break;
		fseek(file_in, chunk.size, SEEK_CUR);
	}
	uint16_t sample_size = header.BitsPreSample / 8;
	uint32_t samples_count = chunk.size / sample_size;
	printf("Samples=%d\n", samples_count);

	fwrite(&header, sizeof(header), 1, file_out);
	fwrite(&chunk, sizeof(chunk), 1, file_out);

	int16_t s_buf[ONE_SIZE * 2];
	int16_t outputL;
	int16_t outputR;
	int64_t Acc = 0;
	int32_t fixcoefs[ONE_SIZE];
	coef2fixd(coefs, fixcoefs, 128);

	Ring sample_buf;
	RING_Init(&sample_buf);

	while (1)
	{
		size_t read_size = fread(s_buf, 2 * sample_size, ONE_SIZE, file_in);

		if (!read_size)
			break;

		for (int i = 0; i < read_size; i++) {

			sample_buf.buffer_L[sample_buf.index] = s_buf[2 * i];
			sample_buf.buffer_R[sample_buf.index] = s_buf[2 * i + 1];

			outputL = FIR(sample_buf.buffer_L, fixcoefs, sample_buf.index);
			outputR = FIR(sample_buf.buffer_R, fixcoefs, sample_buf.index);

			s_buf[2 * i] = outputL;
			s_buf[2 * i + 1] = outputR;

			sample_buf.index = (sample_buf.index + 1) & ONE_SIZE - 1;
		}
		fwrite(s_buf, 2 * sample_size, read_size, file_out);

	}
	fclose(file_in);
	fclose(file_out);
	printf("\n Noise was filtered.\n");
	system("pause");
	return 0;
}